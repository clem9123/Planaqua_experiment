---
title: "R Notebook"
output: html_notebook
---
```{r warning=FALSE}
library(FSA)
library(RMark)
```

Creation af the capture history data table

```{r}
t <- BDD_a %>% ungroup () %>% pivot_wider(id_cols = Tag_id, names_from = Year, values_from =Lake)
t[] <- lapply(t, as.character)
t[!is.na(t)] <- "1"
t[is.na(t)] <- "0"
t <- data.frame(lapply(t,as.numeric))

#t <- as.matrix(t)

capture_history <- as.data.frame(table(as.factor(paste(t$`2016`, t$`2017`, t$`2018`, t$`2019`, t$`2020`, t$`2021`, t$`2022`, sep=""))))
sum(capture_history$Freq)
```

Compter le nombre de poissons changés de lac

```{r}
fish_mooved <- BDD_a %>% filter (Lake_capture != Lake_released)
Mooved_tag = fish_mooved$Tag_id
table(fish_mooved$Lake_capture)
table(fish_mooved$Lake_released)
```


Model et test

```{r}
capt.hist = capHistSum(t)
pop.estimation <- mrOpen(capt.hist)
summary(pop.estimation)
confint(pop.estimation)
```

Do the same thing but for different lakes (avec le problème des changements de lac)

```{r}

```

Test the method by using only 2017 2018 2019 2020 et 2021 to see if this is really a good estimate
Problem is mooved fishes between 2018 et 2019 (je ne sias pas comment le prendre ne compte)
2 idées : séparer les poissons quand ils ont été déplacés
Si je fais ça est ce qu'il y a moyen de rentrer l'emigration et immigration exacte pour avoir une vraie survie et cie

population parameters estimate with cormak jolly seber model

```{r}
# les données qu'il me faut
t <- BDD_a %>% ungroup () %>% pivot_wider(id_cols = Tag_id, names_from = Year, values_from =Lake)
t[] <- lapply(t, as.character)
t[!is.na(t)] <- "1"
t[is.na(t)] <- "0"

capt_hist <- data.frame(ch = unite(t %>%select(`2016`:`2022`), 
                        col = "ch", 
                        sep = ""))

```

```{r}

phi.p <- mark(capt_hist)
```

```{r}
t <- BDD_a %>% filter(!(Tag_id %in% Mooved_tag)) %>% ungroup () %>% pivot_wider(id_cols = Tag_id, names_from = Year, values_from =Lake)
Lake <- apply(t[-1],1,function(x) unique(na.omit(x))[1]) #%>% unlist()
t[] <- lapply(t, as.character)

t[!is.na(t)] <- "1"
t[is.na(t)] <- "0"
t <- cbind(t,Lake) %>% merge(Lake_treatment, all = TRUE)
capt_hist <- data.frame(ch = unite(t %>%select(`2016`:`2022`), 
                        col = "ch", 
                        sep = ""),
                        Lake = t$Lake,
                        Treatment = t$Treatment,
                        Perch = t$Perch,
                        Nutrients = t$Nutrients)
```

```{r}
capt_hist.proc <- process.data(capt_hist, groups = c("Lake","Treatment","Perch","Nutrients"))
capt_hist.ddl <- make.design.data(data = capt_hist.proc)
```

```{r}
philake <- list(formula= ~ Lake)
p <- list(formula = ~ 1)
```

```{r}
philake.p <- mark(capt_hist.proc,
                 capt_hist.ddl,
                 model.parameters = list(Phi = philake, p = p))
```

```{r}
summary(philake.p)
philake.p$result$real
```

```{r}
phit <- list(formula = ~ time)
phitreatment <- list(formula = ~ Treatment)
phiperch <- list(formula = ~ Perch)
phitperch <- list(formula = ~time + Perch)
phinutrients <- list(formula = ~ Nutrients)
phitnutrients <- list(formula = ~ time + Nutrients)
phitlake <- list(formula = ~ time + Lake)
```

```{r message=FALSE, warning=FALSE}
phit.p <- mark(capt_hist.proc,
                 capt_hist.ddl,
                 model.parameters = list(Phi = phit, p = p))
```

```{r}
phitlake.p <- mark(capt_hist.proc,
                 capt_hist.ddl,
                 model.parameters = list(Phi = phitlake, p = p))
```


```{r}
phittreatment <- list(formula = ~ time + Treatment)
```

```{r}
phitreatment.p <- mark(capt_hist.proc,
                 capt_hist.ddl,
                 model.parameters = list(Phi = phitreatment, p = p))
phittreatment.p <- mark(capt_hist.proc,
                 capt_hist.ddl,
                 model.parameters = list(Phi = phittreatment, p = p))
phinutrients.p <- mark(capt_hist.proc,
                 capt_hist.ddl,
                 model.parameters = list(Phi = phinutrients, p = p))
phiperch.p <- mark(capt_hist.proc,
                 capt_hist.ddl,
                 model.parameters = list(Phi = phiperch, p = p))
```

```{r}
phitnutrients.p <- mark(capt_hist.proc,
                 capt_hist.ddl,
                 model.parameters = list(Phi = phitnutrients, p = p))
phitperch.p <- mark(capt_hist.proc,
                 capt_hist.ddl,
                 model.parameters = list(Phi = phitperch, p = p))
```
```{r}
phitest <- list(formula = ~ time + Perch + Nutrients)

phinutrients.p <- mark(capt_hist.proc,
                 capt_hist.ddl,
                 model.parameters = list(Phi = phitest, p = p))
```

```{r}
collect.models()
```

Look at the estimates -- > see the effects (cyclique, début des naissances...)
Faire sans 2016 et 2020 --> fausse les données, regarder déja dans l'abondance si ça fausse les données
Est ces que les models peuvent prendre en compte les juvéniles
Comment marche le CJS model -- > écrire les formules et tout dans un beau markdown, déjà sur une belle feulle dans mon cahier
Faire des groupes de tailles -- > regarder lesquels ont le plus de sens (par exemple en regardant les tags de 2018)

Etude des tailles -- > article

Stat bayesion markage de truite -- > article

Cours de stat bayesienne

Model sur Jags

