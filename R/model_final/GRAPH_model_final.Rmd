---
title: "R Notebook"
output: html_notebook
---


```{r message=FALSE, warning=FALSE}
library(R2jags)
library(tidyverse)
library(arules)
library(patchwork)

load("R/model_final/Model_Treatment.RData")
load("R/model_final/Model_Treatment_time_and_lake.RData")
load("R/model_final/Model_Treatment_time_x_lake.RData")

source("R/importation_data.R")
```

```{r}
traceplot(Model_Treatment_time_x_lake, ask = F)#[[2]]$mean)
```

Deviance = 9990
DIC = 21 575

C'est beaucoup (plus que Treatment tout simple) malgré cet augmentation de la liberté
C'est bizarre

Ca n'a pas convergé en fait donc normal
Je sais pas trop quoi faire du coup 
  Soit le model est mal écrit
  Soit pas assez de puissance
  ou bien mauvaise initialisation
    surtout mu et epsilon


```{r}
print(Model_Treatment[[2]]$mean)
```

Deviance = 9336
DIC = 17 892

```{r}
print(Model_Treatment_time_x_lake[[2]]$mean)
```

Deviance = 8629
DIC = 15 382

```{r}
epsilon_phi <- data.frame(Lake = factor(1:16), 
                          Treatment = Lake_treatment$Treatment, 
                          epsilon_phi = Model_Treatment_time_and_lake[[2]]$mean$epsilon_phi)

ggplot(epsilon_phi)+
  geom_point(aes(x = Lake ,y = epsilon_phi, color = Treatment))
```

```{r}
epsilon_psi <- data.frame(Lake = factor(1:16), 
                          Treatment = Lake_treatment$Treatment, 
                          epsilon_psi = Model_Treatment_time_and_lake[[2]]$mean$epsilon_psi)

ggplot(epsilon_psi)+
  geom_point(aes(x = Lake ,y = epsilon_psi, color = Treatment))
```

```{r}
model = as.mcmc(Model_Treatment_time_x_lake)
phi = data.frame()
for (n in 1:2){
  for (tr in 1:4){
    for (gs in 1:3){
      for (e in 1:2){
        phi <- rbind(phi, 
               data.frame(model[[n]][,paste("phi",as.character(gs),"[",as.character(tr),",",as.character(e),"]", sep = "")],
                          Size = gs,
                          Treatment = tr,
                          Exp_time = e))
      }
    }
  }
}

sum_phi = phi %>% group_by (Size,Treatment,Exp_time) %>% summarize(mean = mean(var1), min = quantile(var1,0.025), max = quantile(var1,0.975))

ggplot(sum_phi, aes(color = factor(Treatment)))+
  geom_point(aes(x = Treatment, y = mean))+
  geom_errorbar(aes(x = Treatment, ymin = min, ymax = max), width = 0.4)+
  facet_grid(rows = vars(Size), cols = vars(Exp_time))

ggplot(phi)+
  geom_density(aes(x = var1, color = factor(Treatment)))+
  facet_grid(rows = vars(Size), cols = vars(Exp_time))

```

```{r}
model = as.mcmc(Model_Treatment)
phi = data.frame()
for (n in 1:2){
  for (tr in 1:4){
    for (gs in 1:3){
      for (e in 1:2){
        phi <- rbind(phi, 
               data.frame(model[[n]][,paste("phi",as.character(gs),"[",as.character(tr),",",as.character(e),"]", sep = "")],
                          Size = gs,
                          Treatment = tr,
                          Exp_time = e))
      }
    }
  }
}

sum_phi = phi %>% group_by (Size,Treatment,Exp_time) %>% summarize(mean = mean(var1), min = quantile(var1,0.025), max = quantile(var1,0.975))

ggplot(sum_phi, aes(color = factor(Treatment)))+
  geom_point(aes(x = Treatment, y = mean))+
  geom_errorbar(aes(x = Treatment, ymin = min, ymax = max), width = 0.4)+
  facet_grid(rows = vars(Size), cols = vars(Exp_time))
```

```{r}
model = as.mcmc(Model_Treatment_capture)
phi = data.frame()
for (n in 1:2){
  for (tr in 1:4){
    for (gs in 1:3){
      for (e in 1:2){
        phi <- rbind(phi, 
               data.frame(model[[n]][,paste("phi",as.character(gs),"[",as.character(tr),",",as.character(e),"]", sep = "")],
                          Size = gs,
                          Treatment = tr,
                          Exp_time = e))
      }
    }
  }
}

sum_phi = phi %>% group_by (Size,Treatment,Exp_time) %>% summarize(mean = mean(var1), min = quantile(var1,0.025), max = quantile(var1,0.975))

ggplot(sum_phi, aes(color = factor(Treatment)))+
  geom_point(aes(x = Treatment, y = mean))+
  geom_errorbar(aes(x = Treatment, ymin = min, ymax = max), width = 0.4)+
  facet_grid(rows = vars(Size), cols = vars(Exp_time))
```

```{r}
model = as.mcmc(Model_Treatment_capture)
p = data.frame()
for (n in 1:2){
    for (gs in 1:3){
        p <- rbind(p, 
               data.frame(model[[n]][,paste("p",as.character(gs), sep = "")],
                          Size = gs))
  }
}

sum_p = p %>% group_by (Size) %>% summarize(mean = mean(var1), min = quantile(var1,0.025), max = quantile(var1,0.975))

ggplot(sum_p)+
  geom_point(aes(x = Size, y = mean))+
  geom_errorbar(aes(x = Size, ymin = min, ymax = max), width = 0.4)
```

```{r}
model = as.mcmc(Model_treatment_capture)
epsilon = data.frame()
for (n in 1:2){
  for (l in 1:16){
      for (t in 1:5){
        epsilon <- rbind(epsilon, 
               data.frame(model[[n]][,paste("epsilon","[",as.character(l),",",as.character(t),"]", sep = "")],
                          Lake = l,
                          Year = t))
      }
  }
}

sum_epsilon = epsilon %>% group_by (Lake,Year) %>% summarize(mean = mean(var1), min = quantile(var1,0.025), max = quantile(var1,0.975))

ggplot(sum_epsilon)+
  geom_point(aes(x = factor(Lake), y = mean))+
  geom_errorbar(aes(x = factor(Lake), ymin = min, ymax = max), width = 0.4)+
  facet_wrap(~Year)
```

```{r}
model = as.mcmc(Model_treatment_capture)
psi = data.frame()
for (n in 1:2){
  for (tr in 1:4){
    for (gs in 1:2){
      for (e in 1:2){
        psi <- rbind(psi, 
               data.frame(model[[n]][,paste("psi",as.character(gs),as.character(gs+1),"[",as.character(tr),",",as.character(e),"]", sep = "")],
                          Size = gs,
                          Treatment = tr,
                          Exp_time = e))
      }
    }
  }
}

sum_psi = psi %>% group_by (Size,Treatment,Exp_time) %>% summarize(mean = mean(var1), min = quantile(var1,0.025), max = quantile(var1,0.975))

ggplot(sum_psi, aes(color = factor(Treatment)))+
  geom_point(aes(x = Treatment, y = mean))+
  geom_errorbar(aes(x = Treatment, ymin = min, ymax = max), width = 5)+
  facet_grid(rows = vars(Size), cols = vars(Exp_time))
```

```{r}
model = as.mcmc(Model_Treatment)
psi = data.frame()
for (n in 1:2){
  for (tr in 1:4){
    for (gs in 1:2){
      for (e in 1:2){
        psi <- rbind(psi, 
               data.frame(model[[n]][,paste("psi",as.character(gs),as.character(gs+1),"[",as.character(tr),",",as.character(e),"]", sep = "")],
                          Size = gs,
                          Treatment = tr,
                          Exp_time = e))
      }
    }
  }
}

sum_psi = psi %>% group_by (Size,Treatment,Exp_time) %>% summarize(mean = mean(var1), min = quantile(var1,0.025), max = quantile(var1,0.975))

ggplot(sum_psi, aes(color = factor(Treatment)))+
  geom_point(aes(x = Treatment, y = mean))+
  geom_errorbar(aes(x = Treatment, ymin = min, ymax = max), width = 5)+
  facet_grid(rows = vars(Size), cols = vars(Exp_time))
```

```{r}
model = as.mcmc(Model_Treatment_time_x_lake)
epsilon_phi = data.frame()
for (n in 1:2){
  for (l in 1:16){
      for (t in 1:5){
        epsilon_phi <- rbind(epsilon_phi, 
               data.frame(model[[n]][,paste("epsilon_phi","[",as.character(l),",",as.character(t),"]", sep = "")],
                          Year = t,
                          Lake = l))
    }
  }
}

sum_epsilon_phi = epsilon_phi %>% group_by (Year,Lake) %>% summarize(mean = mean(var1), min = quantile(var1,0.025), max = quantile(var1,0.975))

ggplot(sum_epsilon_phi)+#, aes(color = factor(Treatment)))+
  geom_point(aes(x = Year, y = mean))+
  geom_errorbar(aes(x = Year, ymin = min, ymax = max), width = 0.4)+
  facet_wrap(~Lake)
```

```{r}
print(Model_Treatment_time_and_lake[[2]]$DIC)
print(Model_Treatment_time_x_lake[[2]]$DIC)
print(Model_Treatment_capture[[2]]$DIC)
print(Model_treatment_capture[[2]]$DIC)
print(Model_Treatment[[2]]$DIC)

deviance = data.frame()
model = list(Model_Treatment_time_and_lake, Model_Treatment_time_x_lake, Model_Treatment_capture, Model_treatment_capture, Model_Treatment)
name = c("Model_Treatment_time_and_lake", "Model_Treatment_time_x_lake", "Model_Treatment_capture", "Model_treatment_capture", "Model_Treatment")
for (n in 1:2){
    deviance <- rbind (deviance, dev = data.frame(as.mcmc(Model_Treatment_time_and_lake)[[1]][,"deviance"],name = "Model_Treatment_time_and_lake"))
    deviance <- rbind (deviance, dev = data.frame(as.mcmc(Model_Treatment_time_x_lake)[[n]][,"deviance"],name = "Model_Treatment_time_x_lake"))
    deviance <- rbind (deviance, dev = data.frame(as.mcmc(Model_Treatment_capture)[[n]][,"deviance"],name = "Model_Treatment_capture"))
    deviance <- rbind (deviance, dev = data.frame(as.mcmc(Model_treatment_capture)[[n]][,"deviance"],name = "Model_treatment_capture"))
    deviance <- rbind (deviance, dev = data.frame(as.mcmc(Model_Treatment)[[n]][,"deviance"],name = "Model_Treatment"))
}


sum_deviance = deviance %>% group_by(name) %>% summarize(mean = mean(var1), min = quantile(var1,0.025), max = quantile(var1,0.975)) %>% mutate(name = factor(name, level = c("Model_Treatment","Model_Treatment_time_x_lake","Model_Treatment_time_and_lake","Model_Treatment_capture")))
ggplot(sum_deviance %>% filter(name != "Model_treatment_capture"))+
  geom_point(aes(x = name, y = mean, color = name))+
  geom_errorbar(aes(x = name, ymax = max, ymin = min, color = name))+
  labs(x = "Model", y = "Distribution of deviance")+
  theme(legend.position = "none")
```







